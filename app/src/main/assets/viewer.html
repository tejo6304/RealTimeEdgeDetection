<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Edge Detection Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #121212;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
        }

        .header {
            background-color: #1a1a1a;
            padding: 16px;
            border-bottom: 1px solid #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .back-button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-button:hover {
            background-color: #2c2c2e;
            border-radius: 8px;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 12px;
            padding: 12px;
        }

        .gallery-panel {
            width: 120px;
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid #2c2c2e;
        }

        .gallery-item {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #2c2c2e;
            overflow: hidden;
            background-color: #000000;
            transition: all 0.2s ease;
        }

        .gallery-item:hover {
            border-color: #007AFF;
            transform: scale(1.05);
        }

        .gallery-item.active {
            border-color: #007AFF;
            box-shadow: 0 0 12px rgba(0, 122, 255, 0.5);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .viewer-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .image-card {
            background-color: #1a1a1a;
            border-radius: 12px;
            border: 1px solid #2c2c2e;
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .image-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2c2c2e;
        }

        .image-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
        }

        .filter-badge {
            background-color: #007AFF;
            color: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .filter-badge.grayscale {
            background-color: #424242;
        }

        .filter-badge.original {
            background-color: #555555;
        }

        .image-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000000;
            border-radius: 8px;
            overflow: hidden;
            min-height: 0;
        }

        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-container canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .no-image {
            color: #666666;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .no-image svg {
            width: 64px;
            height: 64px;
            opacity: 0.5;
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .stat-card {
            background-color: #2c2c2e;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            border: 1px solid #3a3a3c;
        }

        .stat-label {
            font-size: 11px;
            color: #888888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
        }

        .stat-value.fps {
            color: #00FF00;
        }

        .stat-value.resolution {
            color: #ffffff;
        }

        .stat-value.filter {
            color: #007AFF;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            background-color: #2c2c2e;
            border: 1px solid #3a3a3c;
            color: #ffffff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background-color: #3a3a3c;
        }

        .btn.primary {
            background-color: #007AFF;
            border-color: #007AFF;
        }

        .btn.primary:hover {
            background-color: #0056b3;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
            color: #666666;
        }

        .empty-state-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 14px;
            max-width: 250px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .gallery-panel {
                width: 100%;
                height: auto;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: flex-start;
                align-items: flex-start;
            }

            .gallery-item {
                width: calc(20% - 6.4px);
                aspect-ratio: 1;
            }

            .header h1 {
                font-size: 18px;
            }
        }

        /* Scrollbar styling */
        .gallery-panel::-webkit-scrollbar {
            width: 4px;
        }

        .gallery-panel::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }

        .gallery-panel::-webkit-scrollbar-thumb {
            background: #3a3a3c;
            border-radius: 4px;
        }

        .gallery-panel::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-button" id="backBtn" onclick="goBack()" title="Back">
                ‚Üê Back
            </button>
            <h1>Gallery</h1>
            <div style="width: 60px;"></div>
        </div>

        <div class="content">
            <div class="gallery-panel" id="galleryPanel">
                <!-- Gallery items will be inserted here -->
            </div>

            <div class="viewer-panel">
                <div class="image-card">
                    <div class="image-header">
                        <span class="image-title" id="imageTitle">No Image Selected</span>
                        <span class="filter-badge" id="filterBadge">ORIGINAL</span>
                    </div>
                    <div class="image-container" id="imageContainer">
                        <div class="no-image">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="m21 15-5-5L5 21"/>
                            </svg>
                            <p>Select an image from the gallery</p>
                        </div>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-label">FPS</div>
                        <div class="stat-value fps" id="fpsStat">0.0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">RESOLUTION</div>
                        <div class="stat-value resolution" id="resStat">0x0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">FILTER</div>
                        <div class="stat-value filter" id="filterStat">None</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn" id="downloadBtn" onclick="downloadImage()" title="Download Image">
                        ‚¨á Download
                    </button>
                    <button class="btn" id="deleteBtn" onclick="deleteImage()" title="Delete Image">
                        üóë Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let images = [];
        let currentIndex = -1;
        let frameCount = 0;
        let lastTime = Date.now();

        // Initialize
        function init() {
            loadImages();
            startFpsCounter();
        }

        // Load images from Android or localStorage
        function loadImages() {
            // Check if we're in Android WebView
            if (window.android && window.android.getImages) {
                try {
                    const imagesJson = window.android.getImages();
                    images = JSON.parse(imagesJson);
                } catch (e) {
                    console.error('Error loading images from Android:', e);
                    images = [];
                }
            } else {
                // Fallback to localStorage for testing
                const stored = localStorage.getItem('capturedImages');
                images = stored ? JSON.parse(stored) : [];
            }

            renderGallery();
            if (images.length > 0) {
                selectImage(0);
            }
        }

        // Render gallery items
        function renderGallery() {
            const gallery = document.getElementById('galleryPanel');
            gallery.innerHTML = '';

            images.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = `gallery-item ${index === currentIndex ? 'active' : ''}`;
                item.onclick = () => selectImage(index);
                item.title = `${img.filter || 'Original'} - ${new Date(img.timestamp).toLocaleString()}`;

                const imgEl = document.createElement('img');
                imgEl.src = img.dataUrl;
                imgEl.alt = `Image ${index}`;

                item.appendChild(imgEl);
                gallery.appendChild(item);
            });
        }

        // Select image
        function selectImage(index) {
            if (index >= images.length || index < 0) return;

            currentIndex = index;
            const img = images[index];

            // Update display
            document.getElementById('imageTitle').textContent = `Image ${index + 1} of ${images.length}`;
            document.getElementById('imageContainer').innerHTML = `<img src="${img.dataUrl}" alt="Captured image">`;

            // Update filter badge
            const badge = document.getElementById('filterBadge');
            const filter = img.filter || 'ORIGINAL';
            badge.textContent = filter.toUpperCase();
            badge.className = `filter-badge ${filter.toLowerCase()}`;

            // Update stats
            document.getElementById('filterStat').textContent = filter;
            if (img.width && img.height) {
                document.getElementById('resStat').textContent = `${img.width}x${img.height}`;
            }

            // Update gallery UI
            document.querySelectorAll('.gallery-item').forEach((item, idx) => {
                item.classList.toggle('active', idx === index);
            });

            frameCount++;
        }

        // Download image
        function downloadImage() {
            if (currentIndex < 0 || !images[currentIndex]) return;

            const img = images[currentIndex];
            const link = document.createElement('a');
            link.href = img.dataUrl;
            link.download = `edge-detection-${new Date().getTime()}-${img.filter || 'original'}.jpg`;
            link.click();
        }

        // Delete image
        function deleteImage() {
            if (currentIndex < 0 || !images[currentIndex]) return;

            if (confirm('Are you sure you want to delete this image?')) {
                images.splice(currentIndex, 1);
                saveImages();

                if (images.length === 0) {
                    currentIndex = -1;
                    document.getElementById('imageContainer').innerHTML = `
                        <div class="no-image">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <path d="m21 15-5-5L5 21"/>
                            </svg>
                            <p>No images in gallery</p>
                        </div>
                    `;
                    document.getElementById('imageTitle').textContent = 'No Image Selected';
                } else {
                    selectImage(Math.max(0, currentIndex - 1));
                }

                renderGallery();
            }
        }

        // Save images to localStorage
        function saveImages() {
            localStorage.setItem('capturedImages', JSON.stringify(images));
            if (window.android && window.android.saveImages) {
                window.android.saveImages(JSON.stringify(images));
            }
        }

        // FPS counter
        function startFpsCounter() {
            setInterval(() => {
                const now = Date.now();
                const delta = (now - lastTime) / 1000;
                const fps = frameCount / delta;
                document.getElementById('fpsStat').textContent = fps.toFixed(1);
                frameCount = 0;
                lastTime = now;
            }, 1000);
        }

        // Go back to main activity
        function goBack() {
            if (window.android && window.android.goBack) {
                window.android.goBack();
            } else {
                window.history.back();
            }
        }

        // Handle Android bridge messages
        window.addEventListener('message', (e) => {
            if (e.data.type === 'newImage') {
                images.unshift(e.data.image);
                saveImages();
                renderGallery();
                selectImage(0);
            }
        });

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
